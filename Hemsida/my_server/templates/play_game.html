<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play game</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"
        integrity="sha512-YeeA/Qxn5hYdkukScTCNNOhTrv1C2RubAGButJ1rmgQwZf/HdRaCGl+JAVkqsqaNRaYNHdheiuKKuPf9mDcqKg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="{{url_for('static', filename='style.css')}}">
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"
        integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    <script src="{{url_for('static', filename='script.js')}}"></script>
</head>

<body>
    <input type="hidden" value="{{game['room_id']}}" id="gameid">
    <!-- <input type="hidden" value="{{game}}" id="gameObject">
    <input type="hidden" value="{{game['players'][0]}}" id="player1">
    <input type="hidden" value="{{game['players'][1]}}" id="player2">
    <input type="hidden" value="{{session['username']}}" id="username"> -->
    <div id="this_user">{{ session['username'] }}</div>
    <script>
        player.room = $("#gameid").val()



        $(document).ready(() => {
            console.log("bläbl")
            console.log($("#this_user").text())
            console.log($("#this_user").text())
            console.log($("#this_user").text())
            console.log($("#this_user").text())
            console.log($("#this_user").text())
            console.log($("#this_user").text())
            console.log($("#this_user").text())
            socket.connect();

            socket.emit('join', {
                room: player.room,
            })

            //socket.on('message_from_server', (data) => {
            //    $("#message").text(data.message)
            //    $("#this_user").val() = data.username
            //})

            socket.on('message_from_server', (data) => {
                $("#message").text(data.message)
                if (data.game != null/*data.message == "start_game"*/) {
                    console.log("NU VILL NAGON STARTA SPELET")
                    start(data.game);
                }
            })

            var start = (start_game) => {
                //if room = 1;
                let room_id = player.room
                //let game = start_game.game
                let player1 = start_game.players[0]
                let player2 = start_game.players[1]

                let data_field_map = null

                let newHead1 = document.createElement("h1")
                newHead1.innerText = "Player: " + player1
                let newHead2 = document.createElement("h1")
                newHead2.innerText = "Player: " + player2
                $("body").append(newHead1)
                $("body").append(newHead2)
                let canvas = document.createElement("canvas")
                canvas.id = "myCanvas"
                $("body").append(canvas)
                //else if room = 2;
                console.log("js document.ready")


                console.log(room_id)
                //console.log(game)
                console.log("player1 :" + player1)
                console.log("player2 :" + player2)
                //console.log("username:" + $("#this_user").val())


                const updatePage = () => {
                    //do socket requests that request info
                    //update the page based on the received info

                    //socket.emit('clientlist', {
                    //    room: room_id
                    //})

                    socket.emit('monster_move', {
                        room: room_id
                    })

                    socket.emit('update_canvas', {
                        room: room_id
                    })
                }

                

                socket.on('update', (data) => {
                    //console.log(data)
                    //console.log(data.field_map)
                    //update canvas based on the data received back from the server

                    data_field_map = data.field_map
                    //Canvas
                    var canvas = document.getElementById("myCanvas");
                    var ctx = canvas.getContext("2d");
                    canvas.width = data.width;
                    canvas.height = data.height;
                    var x = canvas.width / 2;
                    var y = canvas.height - 30;
                    var tileSize = data.tile_size;

                    //Wall
                    var wallHeight = tileSize;
                    var wallWidth = tileSize;
                    var wallArray = [];

                    function loadPositions(wallPosition) {
                        for (colum in data.field_map) {
                            for (square in colum) {
                                //console.log(square)
                            }
                        }
                    }


                    //console.log("hello");

                    //Monster
                    var monsterHeight = tileSize;
                    var monsterWidth = tileSize;
                    var monsterArray = [];

                    //Player
                    var playerHeight = tileSize;
                    var playerWidth = tileSize;

                    //Grid
                    function drawGrid() {
                        ctx.strokeStyle = '#eeeeee';
                        ctx.stroke();
                        for (var i = 0; i <= canvas.width; i += tileSize) {
                            ctx.beginPath();
                            ctx.moveTo(i, 0);
                            ctx.lineTo(i, canvas.height);
                            ctx.stroke();
                        }

                        for (var i = 0; i <= canvas.height; i += tileSize) {
                            ctx.beginPath();
                            ctx.moveTo(0, i);
                            ctx.lineTo(canvas.width, i);
                            ctx.stroke();
                        }

                    }

                    //Wall
                    function drawWall(wallX, wallY) {
                        ctx.beginPath();
                        ctx.rect(wallX, wallY, wallWidth, wallHeight,);
                        ctx.fillStyle = "#0095DD";
                        ctx.fill();
                        ctx.closePath();
                    }

                    //Monster
                    function drawMonster(monsterX, monsterY) {
                        ctx.beginPath();
                        ctx.rect(monsterX, monsterY, monsterWidth, monsterHeight);
                        ctx.fillStyle = "#04d49d";
                        ctx.fill();
                        ctx.closePath();
                    }


                    //Player
                    function drawPlayer(playerX, playerY) {
                        ctx.beginPath();
                        ctx.rect(playerX, playerY, playerWidth, playerHeight);
                        ctx.fillStyle = "#046cd4";
                        ctx.fill();
                        ctx.closePath();
                    }

                    //Gives returns a instence of position with the X and Y position of player with given username
                    

                    function draw() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        drawGrid();
                        drawPlayer();

                        var countX = 0;
                        for (const colum in data.field_map) {
                            if (Object.hasOwnProperty.call(data.field_map, colum)) {
                                const element1 = data.field_map[colum];
                                var countY = 0;
                                for (const square in element1) {
                                    if (Object.hasOwnProperty.call(element1, square)) {
                                        const element2 = element1[square];
                                        if (element2 != null) {
                                            if (element2["type"] == "wall") {
                                                //This is what wall is
                                                //console.log("Wall:" + element2 + "X:" + countX + "Y:" + countY);
                                                drawWall(countX * tileSize, countY * tileSize);
                                            }
                                            if (element2["type"] == "player") {
                                                drawPlayer(countX * tileSize, countY * tileSize)
                                                console.log(element2);
                                            }
                                        }
                                    }
                                    countY++;
                                }
                            }
                            countX++;
                        }

                    }
                    draw();

                })

                //Position class for objects
                class Position {
                    constructor(x, y) {
                        this.x = x;
                        this.y = y;
                    }
                    getX() {
                        return this.x;
                    }
                    getY() {
                        return this.y;
                    }
                    setX(x) {
                        this.x = x;
                    }
                    setY(y) {
                        this.y = y;
                    }


                }
                
                function userPosition(username) {
                    pos = new Position(0, 0);
                    var countX = 0;
                    for (const colum in data_field_map) {
                        if (Object.hasOwnProperty.call(data_field_map, colum)) {
                            const element1 = data_field_map[colum];
                            var countY = 0;
                            for (const square in element1) {
                                if (Object.hasOwnProperty.call(element1, square)) {
                                    const element2 = element1[square];
                                    if (element2 != null) {
                                        if (element2["name"] == username) {
                                            pos.setX = countX;
                                            pos.setY = countY;
                                        }
                                    }
                                }
                                countY++;
                            }
                        }
                        countX++;
                    }
                    return pos;
                }
                //Tar in input från klienten var den vill sin spelare ska röra sig
                //KOD SKA TESTAS
                $("body").on("keypress", function (event) {
                    console.log("Handler for `keypress` called.");
                    let this_player_id = null
                    let username = $("#this_user").text();
                    console.log(player1);
                    console.log(player2);
                    console.log(username);
                    console.log(player1.length);
                    console.log(player2.length);
                    console.log(username.length);

                    if (username == player1) {
                        this_player_id = 0
                        console.log("Spelare 1");
                    }
                    else if (username == player2) {
                        this_player_id = 1
                        console.log("Spelare 2")
                    }
                    let move = null
                    let key = (event.keyCode ?
                        event.keyCode :
                        event.which);
                    let character = String.fromCharCode(key)
                    console.log(character)
                    
                    usernamePosition = userPosition(username);
                    
                    if (character == "d" || character == "ArrowRight" && usernamePosition.getX < canvas.width) {
                        move = 'right'
                        console.log("Höger")
                        console.log("Spelare: " + this_player_id)
                    }
                    else if (character == "a" || character == "ArrowLeft" && usernamePosition.getX > 0) {
                        move = 'left';
                        console.log("Vänster")
                        console.log("Spelare: " + this_player_id)
                    }
                    if (character == "w" || character == "ArrowUp" && usernamePosition.getY > canvas.height) {
                        move = 'up'
                        console.log("Upp")
                        console.log("Spelare: " + this_player_id)
                    }
                    else if (character == "s" || character == "ArrowDown" && usernamePosition.getY > 0) {
                        move = 'down'
                        console.log("Ner")
                        console.log("Spelare: " + this_player_id)
                    }else{
                        console.log("Error, player going out of bounds")
                    }
                    socket.emit('player_move', {
                        room: room_id,
                        player_id: this_player_id,
                        move: move
                    })
                });
                const leave = () => {
                    console.log("Lämna")
                    console.log("Lämna")
                    console.log("Lämna")
                    console.log("Lämna")
                    console.log("Lämna")
                    socket.emit('leave', {
                        room: room_id
                    })
                }
                $("#btnleave").click(() => {
                    leave()
                })
                socket.on('navigate_to', (path) => {
                    window.location.href = path
                })
                setInterval(updatePage, 500)
            }
        })

    </script>

    <!-- <h1>Player 1: {{game['players'][0]}}</h1> -->
    <!-- {% if game['awaiting_players'] == False %}
        <h1>Player 2: {{game['players'][1]}}</h1>
    {% endif %} -->
    <!-- {% if game['awaiting_players'] == False %}
    <canvas id="myCanvas"></canvas>
    {% else %} -->
    <!-- <h3 id="waiting_message">Waiting for player to join...</h3> -->
    <!-- {% endif %} -->

    <p id="message"></p>
    <button id="btnleave">Lämna spel</button>
</body>

</html>