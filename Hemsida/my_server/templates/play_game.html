<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"> 
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play game</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js" integrity="sha512-YeeA/Qxn5hYdkukScTCNNOhTrv1C2RubAGButJ1rmgQwZf/HdRaCGl+JAVkqsqaNRaYNHdheiuKKuPf9mDcqKg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="{{url_for('static', filename='style.css')}}">
    <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    <script src="{{url_for('static', filename='script.js')}}"></script>
</head>
<body>
    <script>
        $(document).onload(()=> {
            let room_id = $("#gameid").val()
            let game = $("#gameObject").val()
            let player1 = $("#player1").val()
            let player2 = $("#player2").val()
            let my_player = $("#username").val()


            const updatePage = () => {
                //do socket requests that request info
                //update the page based on the received info

                socket.emit('monster_move', {
                    room_id : room_id
                })

                socket.emit('update_canvas', {
                    room_id : room_id
                })
            }

            socket.on('update', (data)=> {
                //update canvas based on the data receivec back from the server

                //Skriv här hur canvas ska se ut
            })

            //Tar in input från klienten var den vill sin spelare ska röra sig
            $( "#myCanvas").on( "keypress", function(e) {
                console.log( "Handler for `keypress` called." );
                let my_player_id = null
                if (my_player == player1) {
                    my_player_id = 0
                }
                else if (my_player == player2) {
                    my_player_id = 1
                }
                let move = null
                if (e.key == "Right" || e.key == "ArrowRight") {
                    move = 'right'
                }
                else if(e.key == "Left" || e.key == "ArrowLeft") {
                    move = 'left';
                }
                if(e.key == "Up" || e.key == "ArrowUp") {
                    move = 'up'
                }
                else if(e.key == "Down" || e.key == "ArrowDown") {
                    move = 'down'
                }
                socket.emit('player_move', {
                    room_id: room_id,
                    player_id : my_player_id,
                    //info about the key pressed (for example: move: 'right')
                    move: move
                })
              } );

            setInterval(updatePage, 500)

        })

    </script>
    <input type="hidden" value="{{game.room_id}}" id="gameid">
    <input type="hidden" value="{{game}}" id="gameObject">
    <input type="hidden" value="{{game.players[0].name}}" id="player1">
    <input type="hidden" value="{{game.players[1].name}}" id="player2">
    <input type="hidden" value="{{session['username']}}" id="username">
    
    <h1>Player 1: {{game.players[0].name}}</h1>
    {% if game.awaiting_players == False %}
        <h1>Player 2: {{game.players[1].name}}</h1>
    {% endif %}
    {% if game.start_game() == True %}
        <canvas id="myCanvas" width="800" height="400"></canvas>
    {% else %}
        <h3>Waiting for player to join...</h3>
    {% endif %}

    <button onclick="leaveGame('{{game.room_id}}')">Lämna spel</button>
</body>
</html>